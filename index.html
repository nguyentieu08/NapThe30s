<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nguyễn Tiêu AI - Phiên bản Cộng Đồng</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #0c0c0f; color: #f4f4f5; height: 100dvh; display: flex; flex-direction: column; margin: 0; overflow: hidden; }
        .chat-container { flex: 1; overflow-y: auto; padding: 1rem; display: flex; flex-direction: column; gap: 1rem; }
        .message { max-width: 85%; padding: 0.8rem 1rem; border-radius: 1rem; font-size: 0.95rem; line-height: 1.5; animation: fadeIn 0.2s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .user-message { background: #3b82f6; color: white; align-self: flex-end; border-bottom-right-radius: 2px; }
        .ai-message { background: #1c1c21; border: 1px solid #2d2d33; align-self: flex-start; border-bottom-left-radius: 2px; }
        .input-box { background: #0c0c0f; border-top: 1px solid #2d2d33; padding: 1rem; }
        .input-group { background: #1c1c21; border: 1px solid #3f3f46; border-radius: 1.5rem; display: flex; align-items: center; padding: 0.2rem 1rem; max-width: 48rem; margin: 0 auto; }
        input { background: transparent; border: none; color: white; flex: 1; outline: none; padding: 0.6rem; font-size: 16px; }
        .typing { display: flex; gap: 4px; padding: 5px 0; }
        .dot { width: 4px; height: 4px; background: #71717a; border-radius: 50%; animation: blink 1.4s infinite; }
        @keyframes blink { 0%, 100% { opacity: 0.3; } 50% { opacity: 1; } }
        pre { background: #000; padding: 0.75rem; border-radius: 0.5rem; overflow-x: auto; font-size: 0.85rem; border: 1px solid #333; margin-top: 0.5rem; }
    </style>
</head>
<body>

    <header class="p-4 border-b border-zinc-800 flex items-center justify-between bg-[#0c0c0f]/90 backdrop-blur-md">
        <div class="flex items-center gap-3">
            <div class="w-9 h-9 bg-blue-600 rounded-lg flex items-center justify-center shadow-lg shadow-blue-500/20">
                <i class="fa-solid fa-microchip text-white"></i>
            </div>
            <div>
                <h1 class="font-bold text-sm tracking-tight">Nguyễn Tiêu <span class="text-blue-400">AI Community</span></h1>
                <div class="flex items-center gap-1.5">
                    <span class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></span>
                    <span class="text-[10px] font-bold text-zinc-500 uppercase tracking-widest">v1.0 Stable</span>
                </div>
            </div>
        </div>
        <button onclick="clearChat()" class="text-zinc-500 hover:text-white"><i class="fa-solid fa-trash-can"></i></button>
    </header>

    <main id="chat-viewport" class="chat-container">
        <div id="welcome" class="my-auto text-center py-10">
            <div class="w-16 h-16 bg-zinc-900 border border-zinc-800 rounded-2xl flex items-center justify-center mx-auto mb-4">
                <i class="fa-solid fa-bolt-lightning text-blue-500 text-2xl"></i>
            </div>
            <h2 class="text-xl font-bold">AI Đã Sẵn Sàng!</h2>
            <p class="text-zinc-500 text-xs mt-2 px-10">Nguyễn Tiêu AI - Xin chào. Bạn có thể hỏi bất cứ điều gì ngay bây giờ.</p>
        </div>
        <div id="msg-list" class="flex flex-col gap-4"></div>
    </main>

    <footer class="input-box">
        <div class="input-group">
            <input id="chat-input" type="text" placeholder="Nhập câu hỏi cho AI..." autocomplete="off">
            <button id="send-btn" class="p-2 text-blue-500 hover:scale-110 active:scale-95 transition-all">
                <i class="fa-solid fa-paper-plane"></i>
            </button>
        </div>
        <p class="text-[9px] text-center text-zinc-600 mt-4 font-bold uppercase tracking-[0.2em]">Cơ chế AI Cộng Đồng • Nguyễn Tiêu Dev</p>
    </footer>

    <script>
        const chatInput = document.getElementById('chat-input');
        const sendBtn = document.getElementById('send-btn');
        const msgList = document.getElementById('msg-list');
        const viewport = document.getElementById('chat-viewport');
        const welcome = document.getElementById('welcome');

        let isAsking = false;
        const apiKey = ""; // API Key sẽ được môi trường tự động cung cấp

        async function callGemini(prompt, retries = 5, delay = 1000) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: "Bạn là một trợ lý AI thông minh cho cộng đồng của Nguyễn Tiêu. Hãy trả lời thân thiện, hữu ích và không bao giờ lặp lại câu hỏi của người dùng." }] }
            };

            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    
                    const data = await response.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text || "Tôi không nhận được phản hồi.";
                } catch (err) {
                    if (i === retries - 1) throw err;
                    await new Promise(res => setTimeout(res, delay));
                    delay *= 2; // Exponential backoff
                }
            }
        }

        async function handleChat() {
            const text = chatInput.value.trim();
            if (!text || isAsking) return;

            isAsking = true;
            welcome.style.display = 'none';
            addMessage('user', text);
            chatInput.value = '';

            const aiId = 'ai-' + Date.now();
            addMessage('ai', `<div class="typing"><div class="dot"></div><div class="dot" style="animation-delay:0.2s"></div><div class="dot" style="animation-delay:0.4s"></div></div>`, aiId);
            scrollToBottom();

            try {
                const response = await callGemini(text);
                const aiBubble = document.getElementById(aiId);
                aiBubble.innerHTML = formatAIResponse(response);
            } catch (err) {
                document.getElementById(aiId).innerHTML = `<span class="text-red-400"><i class="fa-solid fa-circle-exclamation mr-1"></i> Không thể kết nối Internet hoặc lỗi API. Vui lòng thử lại sau vài giây!</span>`;
            } finally {
                isAsking = false;
                scrollToBottom();
            }
        }

        function addMessage(role, content, id = '') {
            const div = document.createElement('div');
            div.className = `message ${role === 'user' ? 'user-message' : 'ai-message'}`;
            if (id) div.id = id;
            div.innerHTML = content;
            msgList.appendChild(div);
        }

        function formatAIResponse(text) {
            // Xử lý xuống dòng và code block đơn giản
            return text
                .replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>')
                .replace(/\n/g, '<br>');
        }

        function scrollToBottom() {
            viewport.scrollTop = viewport.scrollHeight;
        }

        function clearChat() {
            msgList.innerHTML = '';
            welcome.style.display = 'block';
        }

        sendBtn.onclick = handleChat;
        chatInput.onkeydown = (e) => { if (e.key === 'Enter') handleChat(); };
    </script>
</body>
</html>

